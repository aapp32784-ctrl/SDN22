<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR Code JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <!-- jsPDF Library for PDF Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f7; /* Latar belakang biru muda */
        }
        /* Style untuk tombol unduh agar sejajar */
        .download-buttons button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .download-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Pembuat QR Code</h1>

        <div class="mb-4">
            <label for="qrInput" class="block text-left text-gray-700 text-sm font-bold mb-2">
                Teks atau URL:
            </label>
            <textarea
                id="qrInput"
                class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-600 focus:border-transparent transition duration-200 resize-y min-h-[100px]"
                placeholder="Masukkan teks atau URL di sini..."
            ></textarea>
        </div>

        <!-- Pemilihan Ukuran QR Code -->
        <div class="mb-4 text-left">
            <label for="qrSizeSelect" class="block text-gray-700 text-sm font-bold mb-2">
                Pilih Ukuran QR Code (piksel):
            </label>
            <select
                id="qrSizeSelect"
                class="w-full p-3 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-blue-600 focus:border-transparent transition duration-200"
            >
                <option value="200">200x200 px (Standar)</option>
                <option value="300">300x300 px</option>
                <option value="400">400x400 px</option>
                <option value="500">500x500 px</option>
                <option value="750">750x750 px</option>
                <option value="1000">1000x1000 px (Maksimal)</option>
            </select>
        </div>
        <!-- End Pemilihan Ukuran QR Code -->

        <!-- Tombol Refresh -->
        <button
            id="refreshBtn"
            class="w-full bg-blue-400 text-white py-2 px-6 rounded-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition duration-300 text-md font-semibold shadow-md mb-6"
        >
            Reset Aplikasi
        </button>
        <!-- End Tombol Refresh -->

        <!-- Form untuk Gambar -->
        <div class="mb-6 border border-gray-300 rounded-md p-4 bg-gray-50">
            <label for="qrImageInput" class="block text-gray-700 text-sm font-bold mb-2 text-left">
                Tambahkan Gambar ke QR Code (Opsional):
            </label>
            <input
                type="file"
                id="qrImageInput"
                accept="image/*"
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
            >
            <div class="mt-4 flex justify-center">
                <img id="qrImagePreview" src="" alt="Pratinjau Gambar QR Code" class="hidden max-w-[100px] max-h-[100px] rounded-md border border-gray-200 object-contain">
            </div>
            <button
                id="clearImageBtn"
                class="mt-3 px-3 py-1 bg-blue-200 text-blue-700 text-sm rounded-md hover:bg-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
            >
                Hapus Gambar
            </button>
        </div>
        <!-- End Form untuk Gambar -->

        <button
            id="generateQrBtn"
            class="w-full bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 transition duration-300 text-lg font-semibold shadow-md"
        >
            Buat QR Code
        </button>

        <div id="qrcode" class="mt-8 flex justify-center items-center p-4 border border-gray-200 rounded-lg bg-gray-50 min-h-[200px]">
            <!-- QR Code akan dirender di sini -->
            <p class="text-gray-500">QR Code Anda akan muncul di sini setelah dibuat.</p>
        </div>

        <!-- Ukuran File Estimasi -->
        <div id="fileSizeDisplay" class="mt-4 text-gray-600 text-sm hidden">
            <!-- Estimasi ukuran file akan ditampilkan di sini -->
        </div>
        <!-- End Ukuran File Estimasi -->

        <div id="downloadButtons" class="mt-6 hidden flex flex-col sm:flex-row justify-center gap-4">
            <button
                id="downloadPngBtn"
                class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 text-md font-semibold"
            >
                Unduh PNG
            </button>
            <button
                id="downloadJpgBtn"
                class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 text-md font-semibold"
            >
                Unduh JPG
            </button>
            <button
                id="downloadPdfBtn"
                class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-offset-2 text-md font-semibold"
            >
                Unduh PDF
            </button>
        </div>

        <div id="messageBox" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <span class="block sm:inline" id="messageText"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('messageBox').classList.add('hidden')">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Tutup</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.697l-2.651 2.652a1.2 1.2 0 1 1-1.697-1.697L8.303 10 5.651 7.348a1.2 1.2 0 1 1 1.697-1.697L10 8.303l2.651-2.652a1.2 1.2 0 0 1 1.697 1.697L11.697 10l2.652 2.651a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>
    </div>

    <script>
        // Menginisialisasi variabel global yang disediakan oleh lingkungan Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Mendapatkan referensi ke elemen DOM
        const qrInput = document.getElementById('qrInput');
        const qrSizeSelect = document.getElementById('qrSizeSelect'); // New: Elemen pilihan ukuran
        const generateQrBtn = document.getElementById('generateQrBtn');
        const qrcodeDiv = document.getElementById('qrcode');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const downloadButtonsDiv = document.getElementById('downloadButtons');
        const downloadPngBtn = document.getElementById('downloadPngBtn');
        const downloadJpgBtn = document.getElementById('downloadJpgBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const qrImageInput = document.getElementById('qrImageInput');
        const qrImagePreview = document.getElementById('qrImagePreview');
        const clearImageBtn = document.getElementById('clearImageBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const fileSizeDisplay = document.getElementById('fileSizeDisplay');

        let qrcodeInstance = null; // Untuk menyimpan instance QR Code
        let selectedImageDataUrl = null; // Untuk menyimpan DataURL gambar yang dipilih

        // Fungsi untuk menampilkan pesan error/informasi
        function showMessage(message, type = 'error') {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            if (type === 'error') {
                messageBox.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700', 'bg-green-100', 'border-green-400', 'text-green-700'); // Hapus warna sukses/info
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700'); // Tambahkan warna error
            } else { // 'success' or 'info'
                messageBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700'); // Hapus warna error
                messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700'); // Gunakan warna biru untuk sukses/info
            }
        }

        /**
         * Fungsi untuk mengunduh gambar dari canvas dengan padding.
         * @param {HTMLCanvasElement} originalCanvas - Canvas asli yang berisi QR Code.
         * @param {string} filename - Nama file untuk diunduh.
         * @param {string} mimeType - Tipe MIME gambar (e.g., 'image/png', 'image/jpeg').
         * @param {number} [quality=0.9] - Kualitas gambar untuk JPEG (0-1).
         */
        function downloadImageWithPadding(originalCanvas, filename, mimeType, quality = 0.9) {
            const padding = 20; // Padding dalam piksel
            const newWidth = originalCanvas.width + 2 * padding;
            const newHeight = originalCanvas.height + 2 * padding;

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = newWidth;
            tempCanvas.height = newHeight;
            const ctx = tempCanvas.getContext('2d');

            // Isi latar belakang dengan putih
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, newWidth, newHeight);

            // Gambar QR Code ke tengah canvas baru dengan padding
            ctx.drawImage(originalCanvas, padding, padding, originalCanvas.width, originalCanvas.height);

            const dataUrl = mimeType === 'image/jpeg' ? tempCanvas.toDataURL(mimeType, quality) : tempCanvas.toDataURL(mimeType);

            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        /**
         * Fungsi untuk menggambar gambar ke tengah QR Code canvas.
         * @param {HTMLCanvasElement} canvas - Canvas QR Code.
         * @param {string} imageDataUrl - DataURL dari gambar yang akan digambar.
         */
        function drawImageOnQrCode(canvas, imageDataUrl) {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                const qrSize = canvas.width;
                const imgSize = qrSize * 0.25; // Gambar akan 25% dari ukuran QR Code
                const x = (qrSize - imgSize) / 2;
                const y = (qrSize - imgSize) / 2;

                // Hapus area di mana gambar akan ditempatkan untuk menghindari tumpang tindih piksel QR code yang tidak diinginkan
                // Ini penting untuk menjaga agar QR code tetap bisa dipindai
                ctx.clearRect(x, y, imgSize, imgSize);
                // Gambar gambar
                ctx.drawImage(img, x, y, imgSize, imgSize);
            };
            img.src = imageDataUrl;
        }

        /**
         * Fungsi untuk memperbarui tampilan ukuran file estimasi.
         * @param {HTMLCanvasElement} canvas - Canvas QR Code.
         */
        function updateFileSizeDisplay(canvas) {
            if (!canvas) {
                fileSizeDisplay.textContent = '';
                fileSizeDisplay.classList.add('hidden');
                return;
            }

            // Dapatkan ukuran untuk PNG (kualitas maksimal yang direferensikan)
            canvas.toBlob((blob) => {
                if (blob) {
                    const sizeInBytes = blob.size;
                    let sizeText = '';
                    if (sizeInBytes < 1024) {
                        sizeText = `${sizeInBytes} bytes`;
                    } else if (sizeInBytes < 1024 * 1024) {
                        sizeText = `${(sizeInBytes / 1024).toFixed(2)} KB`;
                    } else {
                        sizeText = `${(sizeInBytes / (1024 * 1024)).toFixed(2)} MB`;
                    }
                    fileSizeDisplay.textContent = `Ukuran Estimasi PNG: ${sizeText}`;
                    fileSizeDisplay.classList.remove('hidden');
                } else {
                    fileSizeDisplay.textContent = '';
                    fileSizeDisplay.classList.add('hidden');
                    console.error('Gagal membuat blob dari canvas.');
                }
            }, 'image/png'); // Hitung ukuran untuk PNG
        }

        // Fungsi untuk mereset aplikasi ke kondisi awal
        function resetApplication() {
            qrInput.value = ''; // Kosongkan input teks
            qrSizeSelect.value = '200'; // Reset pilihan ukuran ke default

            // Hapus gambar yang dipilih
            qrImageInput.value = '';
            selectedImageDataUrl = null;
            qrImagePreview.src = '';
            qrImagePreview.classList.add('hidden');

            // Reset tampilan QR Code
            qrcodeDiv.innerHTML = '<p class="text-gray-500">QR Code Anda akan muncul di sini setelah dibuat.</p>';
            qrcodeDiv.classList.add('min-h-[200px]');
            qrcodeDiv.classList.remove('p-0');
            qrcodeInstance = null; // Reset instance QR Code

            // Sembunyikan tombol unduh
            downloadButtonsDiv.classList.add('hidden');

            // Sembunyikan dan kosongkan tampilan ukuran file
            fileSizeDisplay.textContent = '';
            fileSizeDisplay.classList.add('hidden');

            // Sembunyikan pesan
            messageBox.classList.add('hidden');
        }


        // Event listener untuk tombol "Buat QR Code"
        generateQrBtn.addEventListener('click', () => {
            const data = qrInput.value.trim();
            const qrSize = parseInt(qrSizeSelect.value); // Ambil ukuran yang dipilih

            messageBox.classList.add('hidden'); // Sembunyikan pesan

            if (data) {
                qrcodeDiv.innerHTML = ''; // Hapus QR Code sebelumnya
                qrcodeDiv.classList.remove('min-h-[200px]');
                qrcodeDiv.classList.add('p-0');

                // Buat instance QR Code baru dengan ukuran yang dipilih
                qrcodeInstance = new QRCode(qrcodeDiv, {
                    text: data,
                    width: qrSize,  // Gunakan ukuran yang dipilih
                    height: qrSize, // Gunakan ukuran yang dipilih
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                // Tunggu sebentar agar QR Code benar-benar dirender ke canvas
                setTimeout(() => {
                    const qrCanvas = qrcodeDiv.querySelector('canvas');
                    if (qrCanvas) {
                        if (selectedImageDataUrl) {
                            drawImageOnQrCode(qrCanvas, selectedImageDataUrl);
                        }
                        updateFileSizeDisplay(qrCanvas); // Perbarui ukuran file
                    }
                }, 100); // Penundaan singkat


                downloadButtonsDiv.classList.remove('hidden'); // Tampilkan tombol unduh
                showMessage('QR Code berhasil dibuat!', 'success');
            } else {
                qrcodeDiv.innerHTML = '<p class="text-gray-500">QR Code Anda akan muncul di sini setelah dibuat.</p>';
                qrcodeDiv.classList.add('min-h-[200px]');
                qrcodeDiv.classList.remove('p-0');
                downloadButtonsDiv.classList.add('hidden'); // Sembunyikan tombol unduh jika input kosong
                fileSizeDisplay.classList.add('hidden'); // Sembunyikan ukuran file
                showMessage('Masukkan teks atau URL untuk membuat QR Code.', 'error');
            }
        });

        // Event listener untuk input gambar
        qrImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImageDataUrl = e.target.result;
                    qrImagePreview.src = selectedImageDataUrl;
                    qrImagePreview.classList.remove('hidden');
                    // Jika QR Code sudah ada, buat ulang dengan gambar
                    if (qrcodeDiv.querySelector('canvas') && qrInput.value.trim() !== '') {
                        generateQrBtn.click(); // Panggil ulang pembuatan QR Code
                    }
                };
                reader.readAsDataURL(file);
            } else {
                selectedImageDataUrl = null;
                qrImagePreview.src = '';
                qrImagePreview.classList.add('hidden');
                // Jika QR Code sudah ada, buat ulang tanpa gambar
                if (qrcodeDiv.querySelector('canvas') && qrInput.value.trim() !== '') {
                    generateQrBtn.click(); // Panggil ulang pembuatan QR Code
                }
            }
        });

        // Event listener untuk tombol Hapus Gambar
        clearImageBtn.addEventListener('click', () => {
            qrImageInput.value = ''; // Hapus file dari input
            selectedImageDataUrl = null;
            qrImagePreview.src = '';
            qrImagePreview.classList.add('hidden');
            // Jika QR Code sudah ada, buat ulang tanpa gambar
            if (qrcodeDiv.querySelector('canvas') && qrInput.value.trim() !== '') {
                generateQrBtn.click(); // Panggil ulang pembuatan QR Code
            }
        });

        // Event listener untuk tombol Unduh PNG
        downloadPngBtn.addEventListener('click', () => {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (canvas) {
                downloadImageWithPadding(canvas, 'qrcode.png', 'image/png');
            } else {
                showMessage('Tidak ada QR Code yang bisa diunduh. Harap buat QR Code terlebih dahulu.', 'error');
            }
        });

        // Event listener untuk tombol Unduh JPG
        downloadJpgBtn.addEventListener('click', () => {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (canvas) {
                downloadImageWithPadding(canvas, 'qrcode.jpg', 'image/jpeg', 0.9);
            } else {
                showMessage('Tidak ada QR Code yang bisa diunduh. Harap buat QR Code terlebih dahulu.', 'error');
            }
        });

        // Event listener untuk tombol Unduh PDF
        downloadPdfBtn.addEventListener('click', () => {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (canvas) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                // Gunakan canvas dengan padding untuk PDF juga
                const padding = 20;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width + 2 * padding;
                tempCanvas.height = canvas.height + 2 * padding;
                const ctx = tempCanvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                ctx.drawImage(canvas, padding, padding, canvas.width, canvas.height);


                const imgData = tempCanvas.toDataURL('image/png');
                const imgWidth = 60; // Lebar gambar di PDF (sesuaikan jika perlu, lebih besar dari 50 agar lebih jelas)
                const imgHeight = (tempCanvas.height * imgWidth) / tempCanvas.width; // Jaga rasio aspek

                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight); // Posisi (x, y), lebar, tinggi
                doc.save('qrcode.pdf');
            } else {
                showMessage('Tidak ada QR Code yang bisa diunduh. Harap buat QR Code terlebih dahulu.', 'error');
            }
        });

        // Event listener untuk tombol Refresh
        refreshBtn.addEventListener('click', resetApplication);

        // Event listener untuk memastikan tampilan awal yang benar
        window.onload = function() {
            resetApplication();
        };
    </script>
</body>
</html>
